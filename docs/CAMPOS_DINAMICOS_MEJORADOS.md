# üöÄ Campos Din√°micos Mejorados - Implementaci√≥n Optimizada

## üìã Resumen de Mejoras

Se ha implementado un sistema optimizado de campos din√°micos basado en la **Gu√≠a Frontend - Campos Din√°micos JSON** que corrige los problemas actuales y mejora significativamente la funcionalidad.

---

## üîß **Nuevos Archivos Creados**

### 1. `src/services/camposDinamicosService.ts`
**Servicio principal optimizado que implementa todas las mejores pr√°cticas de la gu√≠a:**

- ‚úÖ Headers obligatorios con `empresa_id`
- ‚úÖ URLs construidas seg√∫n la gu√≠a (`/schema/{entidad}`, `/json/{entidad}/{id}/{campo}`)
- ‚úÖ Cach√© inteligente con TTL de 5 minutos
- ‚úÖ Validaci√≥n autom√°tica con `validate=true`
- ‚úÖ Manejo robusto de errores
- ‚úÖ Filtrado autom√°tico de campos vac√≠os
- ‚úÖ Validaci√≥n de tipos seg√∫n esquema

### 2. `src/hooks/useCamposDinamicos.ts`
**Hook optimizado que simplifica el uso de campos din√°micos:**

- ‚úÖ Soporte para esquemas completos (campos fijos + din√°micos)
- ‚úÖ Funciones integradas para CRUD de datos JSON
- ‚úÖ Utilidades de filtrado y validaci√≥n
- ‚úÖ Hook m√∫ltiple para cargar varios esquemas en paralelo
- ‚úÖ Estados de loading y error bien manejados

### 3. `src/components/ejemplos/FormularioDinamicoMejorado.tsx`
**Componente de ejemplo que demuestra el uso correcto:**

- ‚úÖ Validaci√≥n completa del formulario
- ‚úÖ Manejo de errores por campo
- ‚úÖ Estados de loading y guardado
- ‚úÖ Debug information en desarrollo
- ‚úÖ Soporte para creaci√≥n y edici√≥n

---

## üîÑ **Archivos Actualizados**

### 1. `src/config/constants.ts`
```typescript
// Nuevos endpoints seg√∫n la gu√≠a
SCHEMA_COMPLETO: '/schema',           // GET /schema/{entidad}
JSON_DATA: '/json',                   // CRUD /json/{entidad}/{id}/{campo}
```

### 2. `src/services/esquemaService.ts`
- ‚úÖ Integraci√≥n con el nuevo servicio optimizado
- ‚úÖ Fallback al m√©todo anterior para compatibilidad
- ‚úÖ Nuevo m√©todo `obtenerEsquemaCompleto()`
- ‚úÖ Optimizaci√≥n de `actualizarJson()` con mejor manejo de errores

---

## üöÄ **C√≥mo Usar el Nuevo Sistema**

### **Opci√≥n 1: Hook Simplificado (Recomendado)**

```typescript
import { useCamposDinamicos } from '../hooks/useCamposDinamicos';

const MiComponente = () => {
  const {
    esquemaCompleto,
    esquemaJSON,
    loading,
    error,
    guardarDatos,
    filtrarDatos,
    validarDatos
  } = useCamposDinamicos('solicitante', 'info_extra');

  const handleSubmit = async (formData: Record<string, any>) => {
    const datosLimpios = filtrarDatos(formData);
    const datosValidados = validarDatos(datosLimpios);
    await guardarDatos(recordId, datosValidados, true);
  };

  // ... resto del componente
};
```

### **Opci√≥n 2: Servicio Directo**

```typescript
import { camposDinamicosAPI } from '../services/camposDinamicosService';

// Obtener esquema completo
const esquema = await camposDinamicosAPI.obtenerEsquemaCompleto('solicitante');

// Guardar datos con validaci√≥n
await camposDinamicosAPI.actualizarVariasClavesJSON(
  'solicitante', 123, 'info_extra', datos, true
);

// Leer datos espec√≠ficos
const datos = await camposDinamicosAPI.leerCampoJSON('solicitante', 123, 'info_extra');
```

### **Opci√≥n 3: Servicio Existente (Compatibilidad)**

```typescript
import { esquemaService } from '../services/esquemaService';

// Funciona igual que antes, pero optimizado internamente
const esquema = await esquemaService.obtenerEsquema('solicitante', 'info_extra', 1);
await esquemaService.actualizarJson('solicitante', 123, 'info_extra', datos, 1, true);

// NUEVO: Esquema completo
const esquemaCompleto = await esquemaService.obtenerEsquemaCompleto('solicitante', 1);
```

---

## üéØ **Migraci√≥n de Componentes Existentes**

### **Antes:**
```typescript
const { esquemas, loading } = useEsquemasCompletos(esquemasConfig);
// M√∫ltiples hooks y servicios diferentes
```

### **Despu√©s:**
```typescript
const configuraciones = [
  { entidad: 'solicitante', campoJson: 'info_extra' },
  { entidad: 'ubicacion', campoJson: 'detalle_direccion' }
];

const { esquemas, loading } = useMultiplesCamposDinamicos(configuraciones);
// Un solo hook optimizado
```

---

## üîç **Caracter√≠sticas Principales**

### **1. Cach√© Inteligente**
- TTL de 5 minutos seg√∫n la gu√≠a
- Cache por empresa y entidad
- Limpieza autom√°tica al cambiar empresa

### **2. Validaci√≥n Robusta**
- Validaci√≥n de tipos seg√∫n esquema
- Filtrado de campos vac√≠os
- Validaci√≥n de backend con `validate=true`

### **3. Manejo de Errores**
- Fallback autom√°tico a m√©todos anteriores
- Mensajes de error descriptivos
- Estados de error por componente

### **4. Multi-tenant**
- Soporte completo para `empresa_id`
- Headers autom√°ticos seg√∫n la gu√≠a
- Cambio din√°mico de empresa

### **5. Performance Optimizada**
- Carga en paralelo de m√∫ltiples esquemas
- Cach√© compartido entre componentes
- Minimizaci√≥n de requests redundantes

---

## üß™ **Pruebas y Debug**

### **Modo Desarrollo**
Los componentes muestran informaci√≥n de debug en desarrollo:

```typescript
// Informaci√≥n del esquema
{process.env.NODE_ENV === 'development' && (
  <div>
    Entidad: {esquemaCompleto.entidad}
    Campos din√°micos: {esquemaCompleto.campos_dinamicos.length}
  </div>
)}

// Datos del formulario
{process.env.NODE_ENV === 'development' && (
  <pre>{JSON.stringify(formData, null, 2)}</pre>
)}
```

### **Logging Autom√°tico**
El servicio registra autom√°ticamente:
- URLs construidas
- Respuestas del backend
- Errores y fallbacks
- Datos enviados y recibidos

---

## üìä **Entidades y Campos Soportados**

| **Entidad** | **Tabla** | **Campo JSON** | **Descripci√≥n** |
|-------------|-----------|----------------|-----------------|
| `solicitante` | `solicitantes` | `info_extra` | Informaci√≥n personal adicional |
| `ubicacion` | `ubicaciones` | `detalle_direccion` | Detalles de ubicaci√≥n |
| `actividad_economica` | `actividad_economica` | `detalle_actividad` | Informaci√≥n laboral |
| `informacion_financiera` | `informacion_financiera` | `detalle_financiera` | Datos financieros |
| `referencia` | `referencias` | `detalle_referencia` | Referencias personales |
| `solicitud` | `solicitudes` | `detalle_credito` | Detalles del cr√©dito |

---

## ‚ö†Ô∏è **Consideraciones Importantes**

### **1. Compatibilidad**
- Los m√©todos existentes siguen funcionando
- Fallback autom√°tico si el nuevo servicio falla
- Migraci√≥n gradual posible

### **2. Configuraci√≥n**
- Verificar que `empresa_id` est√© configurado en localStorage
- Endpoints del backend deben coincidir con la gu√≠a
- Headers de autorizaci√≥n necesarios

### **3. Empresa ID**
Todas las requests incluyen autom√°ticamente `empresa_id`:
```typescript
// Como query parameter (recomendado)
/schema/solicitante?empresa_id=1

// Como header (alternativo)
'X-Empresa-Id': '1'
```

---

## üéâ **Pr√≥ximos Pasos**

1. **Probar el nuevo servicio** con una entidad simple
2. **Migrar componentes existentes** gradualmente
3. **Configurar endpoints del backend** seg√∫n la gu√≠a
4. **Validar funcionalidad completa** en diferentes escenarios
5. **Documentar casos de uso espec√≠ficos** del proyecto

El sistema est√° listo para usar y mejora significativamente la gesti√≥n de campos din√°micos siguiendo todas las mejores pr√°cticas de la gu√≠a! üöÄ

# üöÄ Campos Din√°micos Mejorados - Sistema de Archivos

## üìÅ **Nuevo Tipo: Campo de Archivo**

El sistema de campos din√°micos ahora soporta campos de tipo **"file"** que permiten adjuntar archivos a cualquier entidad del sistema.

### **üéØ Caracter√≠sticas Principales:**

- ‚úÖ **M√∫ltiples tipos de archivo** configurables
- ‚úÖ **L√≠mites de tama√±o** personalizables
- ‚úÖ **Archivos √∫nicos o m√∫ltiples**
- ‚úÖ **Campos adicionales** configurables por archivo
- ‚úÖ **Rutas de almacenamiento** personalizadas
- ‚úÖ **Validaci√≥n autom√°tica** de tipos y tama√±os

## üèóÔ∏è **Estructura del Campo de Archivo**

### **1. Configuraci√≥n B√°sica**
```typescript
{
  key: 'documentos_credito',
  type: 'file',
  required: false,
  description: 'Documentos relacionados al cr√©dito',
  order_index: 6
}
```

### **2. Configuraci√≥n Avanzada**
```typescript
{
  key: 'documentos_credito',
  type: 'file',
  required: false,
  description: 'Documentos relacionados al cr√©dito',
  order_index: 6,
  list_values: {
    file_config: {
      allowed_types: ['pdf', 'doc', 'docx', 'jpg', 'png'],
      max_size_mb: 5,
      multiple: true,
      required_fields: ['descripcion', 'categoria'],
      storage_path: 'creditos/documentos'
    }
  }
}
```

## ‚öôÔ∏è **Opciones de Configuraci√≥n**

### **`allowed_types`**
Array de extensiones permitidas (sin el punto):
```typescript
allowed_types: ['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx', 'xls', 'xlsx']
```

### **`max_size_mb`**
Tama√±o m√°ximo en megabytes:
```typescript
max_size_mb: 10 // 10MB m√°ximo
```

### **`multiple`**
Si permite m√∫ltiples archivos:
```typescript
multiple: true  // M√∫ltiples archivos
multiple: false // Un solo archivo
```

### **`required_fields`**
Campos adicionales requeridos para cada archivo:
```typescript
required_fields: ['descripcion', 'categoria', 'fecha_vencimiento']
```

### **`storage_path`**
Ruta personalizada de almacenamiento:
```typescript
storage_path: 'solicitantes/identificacion'
storage_path: 'creditos/documentos'
storage_path: 'actividad_economica/certificados'
```

## üìã **Ejemplos de Implementaci√≥n**

### **1. C√©dula de Ciudadan√≠a (Archivo √önico)**
```typescript
{
  key: 'cedula',
  type: 'file',
  required: true,
  description: 'C√©dula de ciudadan√≠a',
  order_index: 1,
  list_values: {
    file_config: {
      allowed_types: ['pdf', 'jpg', 'png'],
      max_size_mb: 2,
      multiple: false,
      required_fields: ['fecha_vencimiento'],
      storage_path: 'solicitantes/identificacion'
    }
  }
}
```

### **2. Documentos de Cr√©dito (M√∫ltiples Archivos)**
```typescript
{
  key: 'documentos_credito',
  type: 'file',
  required: false,
  description: 'Documentos relacionados al cr√©dito',
  order_index: 6,
  list_values: {
    file_config: {
      allowed_types: ['pdf', 'doc', 'docx', 'jpg', 'png'],
      max_size_mb: 5,
      multiple: true,
      required_fields: ['descripcion', 'categoria'],
      storage_path: 'creditos/documentos'
    }
  }
}
```

### **3. Certificados Laborales (M√∫ltiples con Campos Espec√≠ficos)**
```typescript
{
  key: 'certificados_laborales',
  type: 'file',
  required: false,
  description: 'Certificados laborales',
  order_index: 2,
  list_values: {
    file_config: {
      allowed_types: ['pdf', 'doc', 'docx'],
      max_size_mb: 3,
      multiple: true,
      required_fields: ['empresa', 'fecha_emision', 'cargo'],
      storage_path: 'solicitantes/laboral'
    }
  }
}
```

## üîß **Componente de Interfaz**

### **Caracter√≠sticas del Componente:**
- üì§ **Bot√≥n de subida** con validaci√≥n visual
- üìä **Barra de progreso** durante la subida
- üóÇÔ∏è **Lista de archivos** con iconos por tipo
- ‚úèÔ∏è **Campos adicionales** configurables
- üóëÔ∏è **Eliminaci√≥n** de archivos
- üì• **Descarga** de archivos existentes

### **Estados Visuales:**
- ‚úÖ **Archivo v√°lido** - Icono verde
- ‚ö†Ô∏è **Archivo en proceso** - Icono girando
- ‚ùå **Archivo inv√°lido** - Icono rojo
- üìÅ **Archivo subido** - Icono del tipo de archivo

## üöÄ **C√≥mo Usar**

### **1. En la Configuraci√≥n de Campos Din√°micos:**
```typescript
// Agregar campo de archivo al esquema
const esquemaConArchivos = [
  ...camposExistentes,
  {
    key: 'mi_campo_archivo',
    type: 'file',
    required: true,
    description: 'Descripci√≥n del campo',
    list_values: {
      file_config: {
        allowed_types: ['pdf', 'jpg'],
        max_size_mb: 5,
        multiple: false,
        required_fields: ['descripcion']
      }
    }
  }
];
```

### **2. En el Frontend:**
```typescript
import { DynamicFileField } from '../components/ui/DynamicFileField';

// Renderizar campo de archivo
<DynamicFileField
  value={data.mi_campo_archivo}
  onChange={(value) => updateData('mi_campo_archivo', value)}
  config={campo.list_values.file_config}
  label="Mi Campo de Archivo"
  required={campo.required}
  entityId={123}
  entityType="solicitante"
  jsonColumn="info_extra"
  fieldKey="mi_campo_archivo"
/>
```

## üîí **Seguridad y Validaci√≥n**

### **Validaciones Autom√°ticas:**
- ‚úÖ **Tipo de archivo** - Solo extensiones permitidas
- ‚úÖ **Tama√±o m√°ximo** - L√≠mite configurable
- ‚úÖ **Archivos m√∫ltiples** - Control de cantidad
- ‚úÖ **Campos requeridos** - Validaci√≥n de metadatos

### **Sanitizaci√≥n:**
- üßπ **Nombres de archivo** - Eliminaci√≥n de caracteres especiales
- üìÅ **Rutas de almacenamiento** - Prevenci√≥n de path traversal
- üîç **Tipos MIME** - Verificaci√≥n de contenido real

## üìä **Almacenamiento y Persistencia**

### **Estructura de Datos:**
```typescript
interface FileItem {
  id: string;
  name: string;
  size: number;
  type: string;
  url?: string;
  uploaded_at: string;
  description?: string;
  // Campos adicionales configurados
  [key: string]: any;
}
```

### **Formato JSONB:**
```json
{
  "mi_campo_archivo": [
    {
      "id": "uuid-archivo-1",
      "name": "documento.pdf",
      "size": 2048576,
      "type": "application/pdf",
      "url": "/uploads/solicitantes/identificacion/documento.pdf",
      "uploaded_at": "2025-01-15T10:30:00Z",
      "descripcion": "C√©dula de ciudadan√≠a",
      "categoria": "identificacion"
    }
  ]
}
```

## üîÑ **Integraci√≥n con Sistema Existente**

### **Compatibilidad:**
- ‚úÖ **Campos existentes** - No se ven afectados
- ‚úÖ **Esquemas actuales** - Funcionan sin cambios
- ‚úÖ **Validaciones** - Se integran autom√°ticamente
- ‚úÖ **Interfaz** - Consistente con otros campos

### **Migraci√≥n:**
- üîÑ **Agregar tipo "file"** a esquemas existentes
- üîÑ **Configurar campos** de archivo seg√∫n necesidades
- üîÑ **Actualizar formularios** para incluir archivos
- üîÑ **Migrar datos** existentes si es necesario

## üìà **Casos de Uso Comunes**

### **1. Documentos de Identificaci√≥n:**
- C√©dulas, pasaportes, licencias
- Fotos de perfil
- Firmas digitalizadas

### **2. Documentos Financieros:**
- Estados de cuenta
- Comprobantes de ingresos
- Declaraciones de renta

### **3. Documentos Laborales:**
- Certificados de trabajo
- Contratos laborales
- Cartas de recomendaci√≥n

### **4. Documentos de Cr√©dito:**
- Solicitudes de cr√©dito
- Avales y garant√≠as
- Documentos de respaldo

## üéØ **Pr√≥ximas Mejoras**

### **Funcionalidades Adicionales:**
- üîÑ **Compresi√≥n autom√°tica** de im√°genes
- üîç **OCR** para documentos PDF
- üì± **Subida desde m√≥vil** con c√°mara
- üåê **Integraci√≥n con nube** (Google Drive, Dropbox)

### **Seguridad Avanzada:**
- üîê **Encriptaci√≥n** de archivos sensibles
- üö´ **Detecci√≥n de malware** en archivos
- üìã **Auditor√≠a completa** de archivos
- üóÇÔ∏è **Clasificaci√≥n autom√°tica** por contenido
